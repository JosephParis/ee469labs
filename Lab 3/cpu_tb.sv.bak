`timescale 1ns/1ps

module cpu_tb();
    logic clk, reset;
    integer test_num;
    
    // Instantiate the CPU
    cpu_top dut (.clk, .reset);
    
    // Clock generation - extra long period (100ns = 10MHz)
    initial begin
        clk = 0;
        forever #50 clk = ~clk;
    end
    
    initial begin
        test_num = 0;
        $display("========================================");
        $display("     CPU Instruction Test Suite");
        $display("========================================\n");
        
        // Initialize
        reset = 1;
        repeat(2) @(posedge clk);
        reset = 0;
        repeat(1) @(posedge clk);
        
        $display("Reset complete. Starting instruction tests...\n");
        
        // Test each instruction type
        // Note: The actual instructions must be in your instruction memory
        // This testbench assumes you have a test program loaded
        
        // ADDI Test
        repeat(1) @(posedge clk);
        $display("\n[Test %0d] Testing ADDI at time=%0t", test_num++, $time);
        assert(dut.control.aluSrc == 2'b10) else $error("ADDI: Wrong aluSrc");
        assert(dut.control.alu_cntrl == 3'b010) else $error("ADDI: Wrong alu_cntrl");
        assert(dut.RegWrite == 1) else $error("ADDI: RegWrite should be 1");
        
        // ADDS Test
        repeat(1) @(posedge clk);
        $display("\n[Test %0d] Testing ADDS at time=%0t", test_num++, $time);
        assert(dut.control.setFlags == 1) else $error("ADDS: Should set flags");
        assert(dut.control.alu_cntrl == 3'b010) else $error("ADDS: Wrong alu_cntrl");
        
        // AND Test
        repeat(1) @(posedge clk);
        $display("\n[Test %0d] Testing AND at time=%0t", test_num++, $time);
        assert(dut.control.alu_cntrl == 3'b100) else $error("AND: Wrong alu_cntrl");
        
        // EOR Test
        repeat(1) @(posedge clk);
        $display("\n[Test %0d] Testing EOR at time=%0t", test_num++, $time);
        assert(dut.control.alu_cntrl == 3'b110) else $error("EOR: Wrong alu_cntrl");
        
        // LSR Test
        repeat(1) @(posedge clk);
        $display("\n[Test %0d] Testing LSR at time=%0t", test_num++, $time);
        assert(dut.control.aluSrc == 2'b11) else $error("LSR: Wrong aluSrc");
        
        // SUBS Test
        repeat(1) @(posedge clk);
        $display("\n[Test %0d] Testing SUBS at time=%0t", test_num++, $time);
        assert(dut.control.setFlags == 1) else $error("SUBS: Should set flags");
        assert(dut.control.alu_cntrl == 3'b011) else $error("SUBS: Wrong alu_cntrl");
        
        // LDUR Test
        repeat(1) @(posedge clk);
        $display("\n[Test %0d] Testing LDUR at time=%0t", test_num++, $time);
        assert(dut.MemRead == 1) else $error("LDUR: MemRead should be 1");
        assert(dut.control.MemtoReg == 1) else $error("LDUR: MemtoReg should be 1");
        
        // STUR Test
        repeat(1) @(posedge clk);
        $display("\n[Test %0d] Testing STUR at time=%0t", test_num++, $time);
        assert(dut.MemWrite == 1) else $error("STUR: MemWrite should be 1");
        assert(dut.RegWrite == 0) else $error("STUR: RegWrite should be 0");
        
        // CBZ Test (with zero flag set)
        repeat(1) @(posedge clk);
        $display("\n[Test %0d] Testing CBZ at time=%0t", test_num++, $time);
        // Branch behavior depends on zero_reg flag
        
        // B.LT Test
        repeat(1) @(posedge clk);
        $display("\n[Test %0d] Testing B.LT at time=%0t", test_num++, $time);
        // Branch behavior depends on N and V flags
        
        // B Test (unconditional)
        repeat(1) @(posedge clk);
        $display("\n[Test %0d] Testing B at time=%0t", test_num++, $time);
        assert(dut.BrTaken == 1) else $error("B: Should always branch");
        assert(dut.RegWrite == 0) else $error("B: RegWrite should be 0");
        
        // Run a few more cycles to see any branch effects
        repeat(10) @(posedge clk);
        
        $display("\n========================================");
        $display("     Test Suite Complete");
        $display("========================================\n");
        $finish;
    end
    
    // Continuous monitoring
    always @(posedge clk) begin
        if (!reset) begin
            $display("Cycle | PC=%3d | Instr=%h | RW=%b MW=%b MR=%b Br=%b | N=%b Z=%b V=%b C=%b",
                     dut.data.PC, dut.data.instruction,
                     dut.RegWrite, dut.MemWrite, dut.MemRead, dut.BrTaken,
                     dut.negative_reg, dut.zero_reg, dut.overflow_reg, dut.carry_out_reg);
        end
    end
    
    // Dump waveforms for viewing in GTKWave or similar
    initial begin
        $dumpfile("cpu_detailed.vcd");
        $dumpvars(0, cpu_detailed_tb);
    end
endmodule